 int packets = 0;
    FD *rset;
    int maxfd = 0;
    int r;
    AirLorconInterface *intf = NULL;
    if (ctx->interfaces == NULL) {
        snprintf( ctx->errstr, LORCON_STATUS_MAX,  "Cannot multi_loop with no interfaces" );
        return -1;
    }
	            int fd = lorcon_get_selectable_fd(intf->lorcon_intf);
    while (packets < counter || counter <= 0) {
        FD_ZERO(&rset);
        maxfd = 0;
        while ((intf = lorcon_multi_get_next_interface(ctx, intf))) {
            int fd = lorcon_get_selectable_fd(intf->lorcon_intf);

            if (fd < 0) {
                lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);
			}
                if (intf->error_handler != NULL) {
                    (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                
                intf = NULL;
                continue;
            }
            FD_SET(fd, &rset);

            if (maxfd < fd){ maxfd = fd; }

        }
		}
        if (maxfd == 0) {
            fprintf(stderr, "lorcon_multi_loop no interfaces with packets left\n");
            return 0;
        }
        if (select(maxfd + 1, &rset, NULL, NULL, NULL) < 0) {
            if (errno != EINTR && errno != EAGAIN) {
                snprintf(ctx->errstr, LORCON_STATUS_MAX, "select fail: %s", strerror(errno));
                return -1;
            }
        

        intf = NULL;
        while ((intf = lorcon_multi_get_next_interface(ctx, intf))) {
            int fd = lorcon_get_selectable_fd(intf->lorcon_intf);

            if (fd < 0) {
                lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);
		}
                if (intf->error_handler != NULL) {
                    (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                }
                intf = NULL;

                continue;
            }
		}
            if (FD_ISSET(fd, &rset)) {
                r = lorcon_dispatch(intf->lorcon_intf, 1, callback, user);

                if (r <= 0) {
                    fprintf(stderr, "Interface stopped reporting packets, removing  from multicap: %s\n",  lorcon_get_capiface(intf->lorcon_intf));
                    lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);
                    if (intf->error_handler != NULL) {
                        (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                    }
                    intf = NULL;
                    continue;
                }

                packets++;
        }    
    RETVAL = packets;
    OUTPUT:
	RETVAL
	
   
   
   
   
   
   
   
   
   
   
   int packets = 0;
    FD *rset;
    int maxfd = 0;
    int r;
    AirLorconInterface *intf = NULL;
    if (ctx->interfaces == NULL) {
        snprintf( ctx->errstr, LORCON_STATUS_MAX,  "Cannot multi_loop with no interfaces" );
        return -1;
    }
    while (packets < counter || counter <= 0) {
        FD_ZERO(&rset);
        maxfd = 0;
        while ((intf = lorcon_multi_get_next_interface(ctx, intf))) {
            int fd = lorcon_get_selectable_fd(intf->lorcon_intf);

            if (fd < 0) {
                lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);

                if (intf->error_handler != NULL) {
                    (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                }
                intf = NULL;
                continue;
            }

            FD_SET(fd, &rset);

            if (maxfd < fd)
                maxfd = fd;

        }
		}
        if (maxfd == 0) {
            fprintf(stderr, "lorcon_multi_loop no interfaces with packets left\n");
            return 0;
        }
        if (select(maxfd + 1, &rset, NULL, NULL, NULL) < 0) {
            if (errno != EINTR && errno != EAGAIN) {
                snprintf(ctx->errstr, LORCON_STATUS_MAX, "select fail: %s", strerror(errno));
                return -1;
            }
        }

        intf = NULL;
        while ((intf = lorcon_multi_get_next_interface(ctx, intf))) {
            int fd = lorcon_get_selectable_fd(intf->lorcon_intf);

            if (fd < 0) {
                lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);

                if (intf->error_handler != NULL) {
                    (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                }

                intf = NULL;

                continue;
            }
		}
            if (FD_ISSET(fd, &rset)) {
                r = lorcon_dispatch(intf->lorcon_intf, 1, callback, user);

                if (r <= 0) {
                    fprintf(stderr, "Interface stopped reporting packets, removing  from multicap: %s\n",  lorcon_get_capiface(intf->lorcon_intf));
                    lorcon_multi_del_interface(ctx, intf->lorcon_intf, 0);
                    if (intf->error_handler != NULL) {
                        (*(intf->error_handler))(ctx, intf->lorcon_intf, intf->error_aux);
                    }
                    intf = NULL;
                    continue;
                }

                packets++;
            
        }    
    RETVAL = packets;
    OUTPUT:
	RETVAL
